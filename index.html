<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Centered Circle Poster (PNG/JPG, GitHub Pages + Local)</title>
<style>
  :root { --w:1080; --h:1920; }
  body { margin:0; font-family:system-ui, Arial; background:#120028; color:#fff; }
  header { padding:12px 16px; text-align:center; }
  .bar { display:flex; gap:10px; padding:12px; flex-wrap:wrap; align-items:center; justify-content:center; }
  input[type="file"], input[type="text"], button {
    font-size:16px; padding:10px; border:none; border-radius:10px; background:#2f085a; color:#fff;
  }
  button { background:#ffa500; color:#230044; font-weight:700; cursor:pointer; }
  .thumbs { display:flex; gap:10px; padding:0 12px 12px; flex-wrap:wrap; justify-content:center; }
  .thumb { position:relative; width:90px; height:160px; border-radius:10px; overflow:hidden; border:2px solid #555; cursor:pointer; }
  .thumb img { width:100%; height:100%; object-fit:cover; display:block; }
  .thumb input { position:absolute; inset:0; opacity:0; cursor:pointer; }
  .thumb.active { border-color:#ffa500; box-shadow:0 0 0 3px rgba(255,165,0,0.35); }
  .stage { display:grid; place-items:center; padding:10px; }
  canvas {
    width:min(94vw,420px);
    height:calc(min(94vw,420px) * 1920 / 1080);
    border-radius:14px; background:#0d001a;
    box-shadow:0 8px 24px rgba(0,0,0,0.35);
  }
  .hint { font-size:12px; opacity:0.85; text-align:center; padding-bottom:6px; }
</style>
</head>
<body>
  <header>
    <h3>World Psoriasis Day â€“ Centered Circle Poster</h3>
    <div class="hint">Works on GitHub Pages (posters/*.png) and locally (PNG/JPG next to this file).</div>
  </header>

  <div class="bar">
    <label>User photo <input id="photoInput" type="file" accept="image/*" capture="environment"></label>
    <label>Name <input id="nameInput" type="text" placeholder="Type name (optional)"></label>
    <button id="saveBtn">Download</button>
  </div>

  <!-- Thumbnails appear after auto-detection -->
  <div class="thumbs" id="thumbs"></div>

  <div class="stage">
    <canvas id="cv" width="1080" height="1920" aria-label="Poster canvas"></canvas>
  </div>

<script>
(() => {
  // 1080x1920 layout
  const W=1080, H=1920;
  const CX=540, CY=960;        // exact center
  const R=330;                 // circle radius (adjust if your ring differs)
  const NAME_Y = CY + R + 120; // name just below the circle

  const BASES = ['3','5','7']; // poster base names to look for

  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');

  const thumbs = document.getElementById('thumbs');
  const photoInput = document.getElementById('photoInput');
  const nameInput  = document.getElementById('nameInput');
  const saveBtn    = document.getElementById('saveBtn');

  let POSTERS = [];       // resolved poster sources with {src,label}
  let posterSrc = null;   // selected poster src
  let posterImg = null;   // Image object
  let photoImg  = null;   // Uploaded user photo

  // ----- Utilities -----
  function loadImage(src){
    return new Promise((resolve, reject)=>{
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = () => reject(new Error('Image failed: '+src));
      img.src = src;
    });
  }

  async function resolveSrc(base){
    // Prefer GitHub Pages folder posters/*.png, fall back to local PNG/JPG near index.html
    const candidates = [
      `posters/${base}.png`,
      `${base}.png`,
      `posters/${base}.jpg`,
      `${base}.jpg`
    ];
    for (const src of candidates) {
      try { await loadImage(src); return src; } catch(e) {}
    }
    return null;
  }

  function autoNameFromFile(file){
    if (!file) return '';
    const base = (file.name||'').replace(/\.[^.]+$/,'').replace(/[_-]+/g,' ').trim();
    return base.split(' ').map(w => w ? w[0].toUpperCase()+w.slice(1) : '').join(' ');
  }

  // ----- Rendering -----
  function draw(){
    // 1) Base poster
    if (posterImg) ctx.drawImage(posterImg, 0, 0, W, H);
    else { ctx.fillStyle = '#2b0063'; ctx.fillRect(0,0,W,H); }

    // 2) User photo auto-fit under centered ring
    if (photoImg){
      ctx.save();
      ctx.beginPath(); ctx.arc(CX, CY, R, 0, Math.PI*2); ctx.closePath(); ctx.clip();
      const bw=2*R, bh=2*R;
      const a = photoImg.width / photoImg.height;
      const ab = bw / bh;
      let dw, dh;
      if (a > ab) { dh = bh; dw = dh * a; } else { dw = bw; dh = dw / a; }
      ctx.drawImage(photoImg, CX - dw/2, CY - dh/2, dw, dh);
      ctx.restore();
    }

    // 3) Visible centered ring on top (always)
    ctx.lineWidth = 6;
    ctx.strokeStyle = 'rgba(0,255,0,0.65)';
    ctx.beginPath(); ctx.arc(CX, CY, R, 0, Math.PI*2); ctx.stroke();

    // 4) Name just below the circle
    const name = (nameInput.value||'').trim();
    if (name){
      ctx.font = '700 64px Arial, sans-serif';
      ctx.fillStyle = '#ffffff';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.shadowColor = 'rgba(0,0,0,0.55)';
      ctx.shadowBlur = 10;
      ctx.fillText(name, W/2, NAME_Y);
      ctx.shadowBlur = 0;
    }
  }

  async function setPoster(src){
    posterSrc = src;
    try { posterImg = await loadImage(src); }
    catch { posterImg = null; }
    draw();
  }

  function buildThumbs(){
    thumbs.innerHTML = '';
    POSTERS.forEach((p, idx) => {
      const lbl = document.createElement('label');
      lbl.className = 'thumb' + (idx===0 ? ' active' : '');
      lbl.dataset.src = p.src;

      const img = document.createElement('img');
      img.src = p.src;
      img.alt = 'Poster ' + p.label;

      const input = document.createElement('input');
      input.type = 'radio';
      input.name = 'poster';
      input.value = p.src;
      input.checked = idx===0;

      lbl.appendChild(img);
      lbl.appendChild(input);
      thumbs.appendChild(lbl);
    });
  }

  // ----- Events -----
  thumbs.addEventListener('change', (e)=>{
    const input = e.target;
    if (input && input.name === 'poster'){
      [...thumbs.querySelectorAll('.thumb')].forEach(t=>t.classList.remove('active'));
      input.closest('.thumb').classList.add('active');
      setPoster(input.value);
    }
  });

  photoInput.addEventListener('change', ()=>{
    const f = photoInput.files[0];
    if (!f){ photoImg = null; draw(); return; }
    const reader = new FileReader();
    reader.onload = async e => {
      try { photoImg = await loadImage(e.target.result); } catch { photoImg = null; }
      if (!nameInput.value) nameInput.value = autoNameFromFile(f);
      draw();
    };
    reader.readAsDataURL(f);
  });

  nameInput.addEventListener('input', draw);

  saveBtn.addEventListener('click', ()=>{
    const a = document.createElement('a');
    const who = (nameInput.value||'user').replace(/\s+/g,'_');
    const base = posterSrc ? posterSrc.split('/').pop().replace(/\.(png|jpg|jpeg)$/i,'') : 'poster';
    a.download = `poster_${base}_${who}.png`;
    a.href = cv.toDataURL('image/png');
    a.click();
  });

  // ----- Init: resolve available poster sources then render -----
  (async () => {
    for (const b of BASES) {
      const src = await resolveSrc(b);
      if (src) POSTERS.push({ src, label: b });
    }
    if (POSTERS.length === 0) {
      // Fallback thumbnail notice
      thumbs.innerHTML = '<div class="hint">No posters found. Add posters/3.png, 5.png, 7.png (or 3.png/5.png/7.png, or JPGs) to this site/folder.</div>';
    } else {
      buildThumbs();
      await setPoster(POSTERS[0].src);
    }
    draw();
  })();
})();
</script>
</body>
</html>